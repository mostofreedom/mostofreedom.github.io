!async function(){function e(e,t,n){if(console.info(e),t<=0)throw new Error("Invalid value for duration");if(n<=0)throw new Error("Invalid value for appearDuration");var o=document.createElement("div");o.style.cssText=`\n\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\ttransition: opacity ${n}s, bottom ${n}s ease-in-out;\n\t\t\t\t\t\tpointer-events: none;\n\t\t\t\t\t\tuser-select: none;\n\t\t\t\t\t\tleft: 1rem;\n\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\tbottom: -3rem;\n\t\t\t\t\t`;var i=document.createElement("div");i.style.cssText="\n\t\t\t\t\t\tpointer-events: none;\n\t\t\t\t\t\tuser-select: none;\n\t\t\t\t\t\tfont-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n\t\t\t\t\t\tfont-size: 1rem;\n\t\t\t\t\t\tpadding: 0.5rem;\n\t\t\t\t\t\tline-height: calc(1rem - 0.2rem);\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tbackground-color: white;\n\t\t\t\t\t\tborder: 0.1rem solid #77f;\n\t\t\t\t\t\tcolor: #77f;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\tmargin-left: auto;\n\t\t\t\t\t\tmargin-right: auto;\n\t\t\t\t\t",i.textContent=e,o.appendChild(i),document.body.appendChild(o),getComputedStyle(o).opacity,o.style.bottom="1rem",o.style.opacity="1",setTimeout((function(){o.style.bottom="-3rem",o.style.opacity="0",setTimeout((function(){document.body.removeChild(o)}),1e3*n)}),1e3*n+1e3*t)}function t(e,t){return e[t]}function n(e,t){return e[t]|e[t+1]<<8}function o(e,t,n){t[n]=255&e}function i(e,t,n){t[n]=255&e,t[n+1]=e>>8&255}window.showConfigDialog=async function(){await r.stopConnection(),document.getElementById("dialog").style.display=null;var t,n,o=document.getElementById("form");o.innerHTML="";for(const[a,s]of Object.entries(r.props)){var i=(t=`\n\t\t\t\t\t\t<div class="input-field">\n\t\t\t\t\t\t\t<label>${a}</label>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<input type="text" value="${s}" id="input-${a}">\n\t\t\t\t\t\t\t\t<input type="button" value="set" id="submit-${a}">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>`,n=void 0,n=document.createElement("template"),t=t.trim(),n.innerHTML=t,n.content.firstChild);o.appendChild(i),document.querySelector(`#submit-${a}`).addEventListener("click",(function(){let t=document.querySelector(`#input-${a}`).value.trim();c(a,t),e(`Set value for ${a}`,1,1)}))}},window.hideConfigDialog=async function(){await r.startConnection(),document.getElementById("dialog").style.display="none"};var r={viewSocket:null,workerLoopTs:0,workerLoopShouldRun:!1};const a={password:"",quality:50,fps:20,ips:5};function s(e){return r.props[e]}function c(e,t){if("password"===e)t=t.trim();else if("quality"===e){try{t=parseInt(t)}catch(e){throw new Error("quality must be in range [1, 100]")}if(t<1||t>100)throw new Error("quality must be in range [1, 100]")}else if("fps"===e){try{t=parseInt(t)}catch(e){throw new Error("fps must be in range [1, inf]")}if(t<1)throw new Error("fps must be in range [1]")}else if("ips"===e){try{t=parseInt(t)}catch(e){throw new Error("ips must be in range [1, inf]")}if(t<1)throw new Error("ips must be in range [1]")}r.props[e]=t,localStorage.setItem("httprd-app.props",JSON.stringify(r.props))}r.props=null,function(){r.props={...a};try{var e=JSON.parse(localStorage.getItem("httprd-app.props"));for(const[n,o]of Object.entries(r.props)){var t=e[n];t&&(r.props[n]=t)}}catch{}}(),r.canvas=document.getElementById("display"),r.canvasContext=r.canvas.getContext("2d");var l=document.querySelector("#netstat");r.startConnection=async function(){console.log("startConnection() : enter"),r.isConnectionRunning?console.log("startConnection() : unstack"):(r.keepAlive=!0,r.viewPromise=null,r.inputPromise=null,r.remote={width:0,height:0},r.viewport={width:0,height:0},r.isConnectionRunning=!0,l.textContent="",r.viewPromise=new Promise(((a,c)=>{var p=!1,u=function(){var c=null,d=function(){if(r.keepAlive&&f.readyState!==WebSocket.CLOSED){var e=new Uint8Array(6);try{o(1,e,0);let t=Math.max(Math.min(window.innerWidth,65535),1),n=Math.max(Math.min(window.innerHeight,65535),1),r=Math.max(Math.min(s("quality"),100),1);i(t,e,1),i(n,e,3),o(r,e,5),c=Date.now(),f.send(e.buffer)}catch(e){console.error(e)}delete e}else try{f.close()}catch{}},h=function(){r.canvas.width==window.innerWidth&&r.canvas.height==window.innerHeight||(r.canvas.width=window.innerWidth,r.canvas.height=window.innerHeight,r.lineHeight=window.getComputedStyle(document.body).lineHeight,r.pageHeight=window.clientHeight)},w=1e3/s("fps");var v=null,m=null;console.info("connect to",`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/connect_view_ws`);var f=new WebSocket(`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/connect_view_ws?password=${encodeURIComponent(s("password"))}`);f.binaryType="arraybuffer",f.onmessage=function(e){if(r.keepAlive&&f.readyState!==WebSocket.CLOSED){if(e.data instanceof ArrayBuffer){var o=new Uint8Array(e.data);if(2==t(o,0)){var i=Date.now()-c;l.textContent=`${i}ms`;try{r.remote.width=n(o,1),r.remote.height=n(o,3);var a=t(o,5);if(6===o.length||0===a)2*w<=i?d():setTimeout(d,2*w-i);else if(1===a){var s=new Blob([o.slice(6)],{type:"image/jpeg"}),p=URL.createObjectURL(s);delete s,(u=new Image).onload=function(){URL.revokeObjectURL(p),h(),r.canvasContext.drawImage(u,r.canvas.width/2-u.width/2,r.canvas.height/2-u.height/2),r.viewport.width=u.width,r.viewport.height=u.height,delete u,w<=i?d():setTimeout(d,w-i)},u.src=p}else if(2===a){var u,v=n(o,6),m=n(o,8);s=new Blob([o.slice(10)],{type:"image/jpeg"}),p=URL.createObjectURL(s);delete s,(u=new Image).onload=function(){URL.revokeObjectURL(p),h(),r.canvasContext.drawImage(u,r.canvas.width/2-r.viewport.width/2+v,r.canvas.height/2-r.viewport.height/2+m),delete u,w<=i?d():setTimeout(d,w-i)},u.src=p}}catch(e){console.error(e),w<=i?d():setTimeout(d,w-i)}}delete o}}else try{f.close()}catch{}},f.onopen=function(e){if(r.keepAlive&&f.readyState!==WebSocket.CLOSED)v=setTimeout((function(){p=!1}),1e3),m=setTimeout((function(){document.title="HTTPRD (Connected)"}),1e3),d();else try{f.close()}catch{}},f.onclose=function(t){4001===t.code?(p||e("No access to input",1,1),clearTimeout(v),p=!0):e("Input connection closed",1,1),clearTimeout(m),document.title="HTTPRD (Disconnected)",r.keepAlive?setTimeout((function(){r.keepAlive?u():a()}),4001===t.code?5e3:1e3):a()},r.viewSocket=f};u()})),r.inputPromise=new Promise(((n,i)=>{var a=!1,c=function(){Date.now();var i=null;console.info("connect to",`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/connect_input_ws`);var l=new WebSocket(`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/connect_input_ws?password=${encodeURIComponent(s("password"))}`);l.binaryType="arraybuffer",l.onmessage=function(e){if(!r.keepAlive)try{r.viewSocket.close()}catch{}if(e.data instanceof ArrayBuffer){var n=new Uint8Array(e.data);t(n,0);delete n}},l.onopen=function(e){if(r.keepAlive&&l.readyState!==WebSocket.CLOSED)i=setTimeout((function(){a=!1}),5e3),function(){console.log("startInputLoop() : starting input loop"),r.canvas.addEventListener("mousemove",mouseMoveEventHandler),r.canvas.addEventListener("wheel",mouseScrollEventHandler),r.canvas.addEventListener("mousedown",mouseDownEventHandler),r.canvas.addEventListener("mouseup",mouseUpEventHandler),r.canvas.addEventListener("contextmenu",contextMenuCancelEventHandler),document.addEventListener("keydown",keyDownEventHandler),document.addEventListener("keyup",keyUpEventHandler);var e=function(){if(r.keepAlive&&l.readyState!==WebSocket.CLOSED){try{if(h.length){var t=h;t=h,h=[];var n=JSON.stringify(t),i=new Uint8Array(1+n.length);o(3,i,0);for(let e=0;e<n.length;++e)i[e+1]=n.charCodeAt(e);l.send(i.buffer),Date.now(),delete i}}catch(e){console.error(e)}setTimeout(e,1e3/s("ips"))}else try{l.close()}catch{}};setTimeout(e,1e3/s("ips"))}();else try{l.close()}catch{}},l.onclose=function(t){console.info("stopInputLoop() : stopping input loop"),r.canvas.removeEventListener("mousemove",mouseMoveEventHandler),r.canvas.removeEventListener("wheel",mouseScrollEventHandler),r.canvas.removeEventListener("mousedown",mouseDownEventHandler),r.canvas.removeEventListener("mouseup",mouseUpEventHandler),r.canvas.removeEventListener("contextmenu",contextMenuCancelEventHandler),document.removeEventListener("keydown",keyDownEventHandler),document.removeEventListener("keyup",keyUpEventHandler),h=[],4001===t.code?(a||e("No access to input",1,1),clearTimeout(i),a=!0):e("Input connection closed",1,1),r.keepAlive?setTimeout((function(){r.keepAlive?c():n()}),4001===t.code?5e3:1e3):n()},r.inputSocket=l;const p={Quote:"'",Plus:"+",Comma:",",Minus:"-",Period:".",Slash:"/",Digit0:"0",Digit1:"1",Digit2:"2",Digit3:"3",Digit4:"4",Digit5:"5",Digit6:"6",Digit7:"7",Digit8:"8",Digit9:"9",Semicolon:";",Equal:"=",BracketLeft:"[",Backslash:"\\",BracketRight:"]",Backquote:"`",KeyA:"a",KeyB:"b",KeyC:"c",KeyD:"d",KeyE:"e",KeyF:"f",KeyG:"g",KeyH:"h",KeyI:"i",KeyJ:"j",KeyK:"k",KeyL:"l",KeyM:"m",KeyN:"n",KeyO:"o",KeyP:"p",KeyQ:"q",KeyR:"r",KeyS:"s",KeyT:"t",KeyU:"u",KeyV:"v",KeyW:"w",KeyX:"x",KeyY:"y",KeyZ:"z",NumpadAdd:"add",AltLeft:"altleft",AltRight:"altright",Backspace:"backspace",BrowserBack:"browserback",BrowserFavourites:"browserfavorites",BrowserForward:"browserforward",BrowserHome:"browserhome",BrowserRefresh:"browserrefresh",BrowserSearch:"browsersearch",BrowserStop:"browserstop",CapsLock:"capslock",Convert:"convert",ControlLeft:"ctrlleft",ControlRight:"ctrlright",NumpadDecimal:"decimal",Delete:"delete",NumpadDivide:"divide",ArrowDown:"down",End:"end",Enter:"enter",Escape:"escape",F1:"f1",F2:"f2",F3:"f3",F4:"f4",F5:"f5",F6:"f6",F7:"f7",F8:"f8",F9:"f9",F10:"f10",F11:"f11",F12:"f12",F13:"f13",F14:"f14",F15:"f15",F16:"f16",F17:"f17",F18:"f18",F19:"f19",F20:"f20",F21:"f21",F22:"f22",F23:"f23",F24:"f24",Fn:"fn",Help:"help",Home:"home",Insert:"insert",KanaMode:"kana",LaunchApp1:"launchapp1",LaunchApp2:"launchapp2",LaunchMail:"launchmail",MediaSelect:"launchmediaselect",ArrowLeft:"left",NumpadMultiply:"multiply",MediaTrackNext:"nexttrack",NonConvert:"nonconvert",Numpad0:"num0",Numpad1:"num1",Numpad2:"num2",Numpad3:"num3",Numpad4:"num4",Numpad5:"num5",Numpad6:"num6",Numpad7:"num7",Numpad8:"num8",Numpad9:"num9",NumLock:"numlock",PageDown:"pagedown",PageUp:"pageup",Pause:"pause",MediaPlayPause:"playpause",MediaTrackPrevious:"prevtrack",Print:"print",PrintScreen:"printscreen",ArrowRight:"right",ScrollLock:"scrolllock",Select:"select",ShiftLeft:"shiftleft",ShiftRight:"shiftright",Sleep:"sleep",Space:"space",MediaStop:"stop",NumpadSubtract:"subtract",Tab:"tab",ArrowUp:"up",AudioVolumeDown:"volumedown",VolumeDown:"volumedown",AudioVolumeMute:"volumemute",AudioVolumeUp:"volumeup",VolumeUp:"volumeup",OSLeft:"winleft",MetaLeft:"winleft",OSRight:"winright",MetaRight:"winright",IntlYen:"yen"};var u=!1,d=!1,h=[],w=(Date.now(),Date.now());mouseMoveEventHandler=function(e){var t=Date.now();if(0===r.viewport.width||0===r.viewport.height||t-w<1e3/s("ips"))return;let n=r.canvas.clientWidth/2-r.viewport.width/2,o=r.canvas.clientHeight/2-r.viewport.height/2;if(e.pageX>=n&&e.pageX<=n+r.viewport.width&&e.pageY>=o&&e.pageY<=o+r.viewport.height){let i=Math.round((e.pageX-n)*r.remote.width/r.viewport.width),a=Math.round((e.pageY-o)*r.remote.height/r.viewport.height);h.push([0,i,a]),w=t}};var v=Date.now();mouseScrollEventHandler=function(e){var t=Date.now();if(0===r.viewport.width||0===r.viewport.height||t-v<1e3/s("ips"))return;let n=r.canvas.clientWidth/2-r.viewport.width/2,o=r.canvas.clientHeight/2-r.viewport.height/2;if(e.pageX>=n&&e.pageX<=n+r.viewport.width&&e.pageY>=o&&e.pageY<=o+r.viewport.height){let i=Math.round((e.pageX-n)*r.remote.width/r.viewport.width),a=Math.round((e.pageY-o)*r.remote.height/r.viewport.height);h.push([3,i,a,-e.deltaY]),v=t}},mouseDownEventHandler=function(e){if(e.preventDefault(),e.stopPropagation(),0===r.remote.width||0===r.remote.height)return;let t=r.canvas.clientWidth/2-r.viewport.width/2,n=r.canvas.clientHeight/2-r.viewport.height/2;if(e.pageX>=t&&e.pageX<=t+r.viewport.width&&e.pageY>=n&&e.pageY<=n+r.viewport.height){let o=Math.round((e.pageX-t)*r.remote.width/r.viewport.width),i=Math.round((e.pageY-n)*r.remote.height/r.viewport.height);h.push([1,o,i,e.button])}},mouseUpEventHandler=function(e){if(e.preventDefault(),e.stopPropagation(),0===r.remote.width||0===r.remote.height)return;let t=r.canvas.clientWidth/2-r.viewport.width/2,n=r.canvas.clientHeight/2-r.viewport.height/2,o=Math.round((e.pageX-t)*r.remote.width/r.viewport.width),i=Math.round((e.pageY-n)*r.remote.height/r.viewport.height);h.push([2,o,i,e.button])},contextMenuCancelEventHandler=function(e){return e.preventDefault(),e.stopPropagation(),!1};var m=Date.now();keyDownEventHandler=function(e){e.preventDefault(),e.stopPropagation(),u=u||"ShiftLeft"===e.code,d=d||"ShiftRight"===e.code;var t=Date.now();if(!(e.repeat&&t-m<1e3/s("ips")))return e.code in p&&(h.push([4,p[e.code]]),m=t),!1},keyUpEventHandler=function(e){return e.preventDefault(),e.stopPropagation(),"ShiftLeft"===e.code||"ShiftRight"===e.code?(u&&h.push([5,p.ShiftLeft]),d&&h.push([5,p.ShiftRight]),v=Date.now()):e.code in p&&(h.push([5,p[e.code]]),v=Date.now()),!1}};c()})),console.log("startConnection() : exit"))},r.stopConnection=async function(){console.log("stopConnection() : enter"),r.keepAlive=!1,await r.viewPromise,await r.inputPromise,r.isConnectionRunning=!1,l.textContent="",console.log("stopConnection() : exit")},r.startConnection()}();
